# Generated by arduino-genmakefile
#
# Command line:
# arduino-genmakefile.py --sketch test.ino --config conf/conf.yaml --config ~/arduino_configs/board/due_native.yaml --config ~/arduino_configs/arduino/due.yaml --makefile Makefile.due_native --qmake test_due_native.pro

export MAKEFILE_PATH = $(abspath $(lastword $(MAKEFILE_LIST)))
export MAKEFILE_DIR = $(dir $(MAKEFILE_PATH))
export BINDIR="$(MAKEFILE_DIR)/bin.due_native"
export BINFILE="$(BINDIR)/test.ino.bin"

export FQBN = "arduino:sam:arduino_due_x"

all: build

build:
	arduino-cli compile "$(MAKEFILE_DIR)/test" \
		--verbose \
		--fqbn $(FQBN) \
		--warnings all \
		--build-property 'compiler.cpp.extra_flags=-I$(CURDIR) -DHAS_LOGGER -DNO_PRAGMA_MARK -DSERIAL_IFACE=SerialUSB' \
		--library "$(MAKEFILE_DIR)/.." \
		--library "$(MAKEFILE_DIR)/../../MemoryFree" \
		--library "$(MAKEFILE_DIR)/../../Sample" \
		--library "$(MAKEFILE_DIR)/../../TFT" \
		--library "$(MAKEFILE_DIR)/../../arduino-printf" \
		--library "$(MAKEFILE_DIR)/../../arduino-logger" \
		--output-dir $(BINDIR)

run: build
	@echo "Searching board type $(FQBN)"; \
	SERIALPORT=`arduino-cli board list | grep "$(FQBN)" | awk '{print $$1}'`; \
	if [ -z $$SERIALPORT ]; then \
		echo "No serial port found"; \
		exit 1; \
	fi; \
	echo "Found board $(FQBN) on port $$SERIALPORT"; \
	echo "Killing apps holding serial port"; \
	for pid in `lsof -t $$SERIALPORT`; do \
		echo killing PID "$$pid"; \
		kill -9 $$pid; \
	done; \
	echo "Starting upload"; \
	arduino-cli upload --fqbn $(FQBN) --port $$SERIALPORT --input-file $(BINFILE); \
	sleep 1; \
	echo "Waiting for serial port to settle"; \
	while [ ! -e $$SERIALPORT ]; do sleep 0.1; done; \
	echo "Serial port is ready"; \
	stty raw -F $$SERIALPORT -echo 115200; \
	echo "Starting command: cat $$SERIALPORT"; \
	cat $$SERIALPORT;

clean:
	rm -rf /tmp/arduino-sketch-*
	rm -rf $(BINDIR)
